<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Paradas de Bus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: linear-gradient(120deg, #e3eafc 0%, #f6faff 100%);
            margin: 0;
            padding: 0;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 38px auto 0 auto;
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 8px 32px #2563eb22;
            padding: 38px 32px 48px 32px;
            animation: fadeInUp 1.1s cubic-bezier(.23,1.01,.32,1) both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        h1 {
            color: #1746a0;
            text-align: center;
            margin-bottom: 38px;
            font-size: 2.2em;
            font-weight: 900;
            letter-spacing: 1px;
            opacity: 0;
            animation: fadeInTitle 1.2s 0.2s cubic-bezier(.23,1.01,.32,1) forwards;
        }
        @keyframes fadeInTitle {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.97);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .chart-card {
            background: #fafdff;
            border-radius: 18px;
            box-shadow: 0 4px 18px #2563eb11;
            padding: 28px 24px 18px 24px;
            transition: box-shadow 0.25s, transform 0.25s;
            border: 1.5px solid #e3eafc;
            opacity: 0;
            transform: translateY(40px) scale(0.98);
            animation: fadeInCard 1s cubic-bezier(.23,1.01,.32,1) forwards;
        }
        .chart-card:nth-child(1) { animation-delay: 0.25s; }
        .chart-card:nth-child(2) { animation-delay: 0.45s; }
        .chart-card:nth-child(3) { animation-delay: 0.65s; }
        @keyframes fadeInCard {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .chart-card:hover {
            box-shadow: 0 12px 36px #2563eb33;
            border: 1.5px solid #2563eb55;
            transform: translateY(-6px) scale(1.015);
        }
        .chart-card h2 {
            font-size: 1.18em;
            color: #2563eb;
            margin-bottom: 18px;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-align: left;
            opacity: 0;
            animation: fadeInTitle 1.2s 0.5s cubic-bezier(.23,1.01,.32,1) forwards;
        }
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            .dashboard-container {
                padding: 10px 2vw 20px 2vw;
            }
            h1 {
                font-size: 1.3em;
            }
            .chart-card {
                padding: 12px 4vw 8px 4vw;
            }
        }
        /* Leyenda personalizada */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin: 10px 0 0 0;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 1em;
            color: #1746a0;
            font-weight: 600;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px #2563eb22;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Dashboard de Paradas de Bus</h1>
        <div class="charts-grid">
            <div class="chart-card">
                <h2>Paradas más concurridas</h2>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-card">
                <h2>Personas esperadas por parada y día</h2>
                <canvas id="lineChart"></canvas>
                <div class="chart-legend" id="lineLegend"></div>
            </div>
            <div class="chart-card" style="grid-column: span 2;">
                <h2>Horas pico por parada y día</h2>
                <canvas id="heatmapChart"></canvas>
                <div class="chart-legend" id="heatmapLegend"></div>
            </div>
        </div>
    </div>
    <script>
async function cargarDashboard() {
    // Colores para las gráficas
    const colores = ['#2563eb', '#22a06b', '#f59e42', '#e53935', '#a259e4', '#10b981', '#f43f5e', '#a21caf', '#f97316', '#0ea5e9', '#64748b'];

    // 1. Paradas más concurridas
    const concurrenciaResp = await fetch('/dashboard/concurrencia');
    const concurrenciaData = await concurrenciaResp.json();
    const paradas = concurrenciaData.map(d => d.nombre);
    const concurrencia = concurrenciaData.map(d => d.total);

    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: paradas,
            datasets: [{
                label: 'Personas por día',
                data: concurrencia,
                backgroundColor: colores,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 1200, easing: 'easeOutQuart' },
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#e3eafc' } },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. Personas esperadas por parada y día
    const esperadosResp = await fetch('/dashboard/esperados');
    const esperadosData = await esperadosResp.json();
    const paradasEsperadas = esperadosData.paradas;
    const dias = esperadosData.dias.map(d => d.charAt(0).toUpperCase() + d.slice(1));
    const datosEsperados = esperadosData.datos;

    const lineChart = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: dias,
            datasets: paradasEsperadas.map((parada, i) => ({
                label: parada,
                data: datosEsperados[i],
                borderColor: colores[i % colores.length],
                backgroundColor: colores[i % colores.length] + '33',
                pointBackgroundColor: colores[i % colores.length],
                pointRadius: 5,
                pointHoverRadius: 7,
                borderWidth: 3,
                tension: 0.35
            }))
        },
        options: {
            responsive: true,
            animation: { duration: 1400, easing: 'easeOutQuart' },
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#e3eafc' } },
                x: { grid: { display: false } }
            }
        }
    });

    // Leyenda personalizada para lineChart
    const lineLegend = document.getElementById('lineLegend');
    lineLegend.innerHTML = '';
    paradasEsperadas.forEach((parada, i) => {
        const item = document.createElement('span');
        item.className = 'legend-item';
        item.innerHTML = `<span class="legend-color" style="background:${colores[i % colores.length]}"></span>${parada}`;
        lineLegend.appendChild(item);
    });

    // 3. Horas pico por parada y día
    const horasPicoResp = await fetch('/dashboard/horas_pico');
    const horasPico = await horasPicoResp.json();

    new Chart(document.getElementById('heatmapChart'), {
        type: 'bar',
        data: {
            labels: horasPico.horas,
            datasets: horasPico.paradas.map((parada, i) => ({
                label: parada,
                data: horasPico.datos[i],
                backgroundColor: colores[i % colores.length],
                stack: 'Stack 0',
                borderRadius: 7,
                borderSkipped: false
            }))
        },
        options: {
            responsive: true,
            animation: { duration: 1600, easing: 'easeOutQuart' },
            plugins: { legend: { display: false } },
            scales: {
                x: { stacked: true, grid: { color: '#e3eafc' } },
                y: { stacked: true, beginAtZero: true, grid: { color: '#e3eafc' } }
            }
        }
    });

    // Leyenda personalizada para heatmapChart
    const heatmapLegend = document.getElementById('heatmapLegend');
    heatmapLegend.innerHTML = '';
    horasPico.paradas.forEach((parada, i) => {
        const item = document.createElement('span');
        item.className = 'legend-item';
        item.innerHTML = `<span class="legend-color" style="background:${colores[i % colores.length]}"></span>${parada}`;
        heatmapLegend.appendChild(item);
    });
}

cargarDashboard();
</script>
</body>
</html>